<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alta de Bobinas</title>
<style>
/* --- TU CSS COMPLETO E IDENTICO --- */
:root{
  --radius:14px;--ink:#111827;--muted:#4b5563;--bg:#f3f4f6;--ok:#065f46;--err:#991b1b;
  --accent:#1e3a8a;--accent-strong:#1d4ed8;--accent-soft:#dbeafe;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:radial-gradient(circle at top,#e5e7eb,#f9fafb);
  color:var(--ink);display:flex;justify-content:center;align-items:flex-start;
  min-height:100vh;padding:24px 12px;
}
.app{
  width:100%;max-width:900px;background:white;border-radius:18px;
  box-shadow:0 18px 45px rgba(15,23,42,0.18);padding:20px 18px 22px;
}
header{
  position:relative;display:flex;align-items:center;justify-content:center;margin-bottom:12px;
}
header h1{
  margin:0;font-size:1.45rem;font-weight:700;letter-spacing:.02em;text-align:center;
}
#btn-home-top{
  position:absolute;right:0;top:50%;transform:translateY(-50%);
  border-radius:999px;border:1px solid #e5e7eb;background:#fff;color:#374151;
  padding:6px 14px;font-size:.8rem;display:inline-flex;align-items:center;gap:6px;
  cursor:default;transition:.15s ease;
}
#btn-home-top.active{
  cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-strong));
  color:#fff;border-color:transparent;box-shadow:0 8px 18px rgba(37,99,235,.4);
}
.screen{
  display:none;border-radius:var(--radius);border:1px solid #e5e7eb;
  background:#f9fafb;padding:16px 14px 18px;
}
.screen.active{display:block}
.screen-title{font-size:1rem;font-weight:600;margin-bottom:6px;display:flex;align-items:center;gap:8px}
.screen-title-strong{
  font-size:1.1rem;color:var(--accent-strong);border-left:4px solid var(--accent-strong);
  padding-left:8px;margin-bottom:8px;
}
.screen-subtitle{font-size:.82rem;color:var(--muted);margin-bottom:12px;line-height:1.45}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.card{
  border-radius:12px;border:1px dashed #e5e7eb;background:white;padding:12px;
}
.card h3{margin:0 0 4px;font-size:.92rem;display:flex;align-items:center;gap:6px}
.card p{margin:0;font-size:.78rem;color:var(--muted)}
.btn{
  border-radius:999px;border:none;cursor:pointer;font-size:.85rem;padding:8px 16px;
  display:inline-flex;align-items:center;gap:6px;font-weight:500;transition:.15s ease;
}
.btn-primary{
  background:linear-gradient(135deg,var(--accent),var(--accent-strong));
  color:white;box-shadow:0 8px 18px rgba(37,99,235,.4);
}
.btn-secondary{background:#f3f4f6;color:#374151;border:1px solid #e5e7eb}
.btn-soft{background:#e0ecff;color:var(--accent-strong);border:1px solid #bfdbfe}
.btn-big{padding:11px 28px;font-size:.9rem;flex:1}
.field-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.field{display:flex;flex-direction:column;gap:2px;font-size:.78rem}
.field label{font-weight:500;display:flex;align-items:center;gap:4px}
.req{color:#dc2626;font-size:.75rem}
.badge-fixed{
  font-size:.68rem;border-radius:999px;padding:1px 6px;background:#fee2e2;color:#b91c1c;
  border:1px solid #fecaca;
}
.badge-auto{
  font-size:.68rem;border-radius:999px;padding:1px 6px;background:#ecfdf3;color:#15803d;
  border:1px solid #bbf7d0;
}
.field input{border:1px solid #d1d5db;border-radius:8px;padding:7px 9px;font-size:.82rem}
.field input[readonly]{background:#f3f4f6;color:#4b5563}
.status{
  margin-top:10px;font-size:.78rem;padding:7px 9px;border-radius:10px;display:none;
  align-items:center;gap:6px;
}
.status.visible{display:inline-flex}
.status.ok{background:#ecfdf3;color:var(--ok);border:1px solid #bbf7d0}
.status.err{background:#fef2f2;color:var(--err);border:1px solid #fecaca}
</style>
</head>
<body>
<main class="app">

<!------------------------------------------------>
<!-- HEADER -->
<!------------------------------------------------>
<header>
  <h1>Alta de Bobinas</h1>
  <button id="btn-home-top"><span>üè†</span><span class="label">Inicio</span></button>
</header>

<!------------------------------------------------>
<!-- HOME -->
<!------------------------------------------------>
<section id="screen-home" class="screen active">
  <div class="screen-title">Panel principal</div>
  <div class="screen-subtitle">
    Eleg√≠ el flujo correspondiente para dar de alta la bobina.
  </div>

  <div class="grid-2">
    <div class="card">
      <h3>Bobinas Verticalizadas</h3>
      <p>Carg√° el SKU y obten√© autom√°ticamente IFR, cantidad y proveedor.</p>
    </div>
    <div class="card">
      <h3>Otros Proveedores</h3>
      <p>Carga manual completa para proveedores externos.</p>
    </div>
  </div>

  <div class="home-actions" style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
    <button class="btn btn-primary" data-screen-jump="vert">‚öôÔ∏è Verticalizada</button>
    <button class="btn btn-primary" data-screen-jump="otros">üì¶ Otros Proveedores</button>
  </div>
</section>

<!------------------------------------------------>
<!-- OTROS PROVEEDORES -->
<!------------------------------------------------>
<section id="screen-otros" class="screen">
  <div class="screen-title screen-title-strong">Otros Proveedores</div>
  <div class="screen-subtitle">Carga manual con validaci√≥n completa.</div>

  <form id="form-otros">
    <div class="field-grid">
      <div class="field">
        <label>IFR <span class="req">*</span></label>
        <input id="otros-ifr" required />
      </div>
      <div class="field">
        <label>Cantidad <span class="req">*</span></label>
        <input id="otros-cantidad" type="number" min="0" step="0.01" required />
      </div>
      <div class="field">
        <label>Proveedor <span class="req">*</span></label>
        <input id="otros-proveedor" required />
      </div>
      <div class="field">
        <label>Fecha <span class="req">*</span></label>
        <input id="otros-fecha" type="date" required />
      </div>
      <div class="field">
        <label>N√∫mero de bobinas <span class="req">*</span></label>
        <input id="otros-num-bobinas" type="number" min="1" step="1" required />
      </div>
      <div class="field">
        <label>Ubicaci√≥n</label>
        <input id="otros-ubicacion" placeholder="Opcional" />
      </div>
    </div>

    <div class="btn-row-main" style="margin-top:10px">
      <button id="btn-otros-crear" type="button" class="btn btn-primary btn-big">‚úÖ Crear bobina</button>
      <button type="reset" class="btn btn-secondary">üßπ Limpiar</button>
    </div>

    <div id="status-otros" class="status">
      <span>‚óè</span><span class="msg"></span>
    </div>
  </form>
</section>

<!------------------------------------------------>
<!-- VERTICALIZADA -->
<!------------------------------------------------>
<section id="screen-vert" class="screen">
  <div class="screen-title screen-title-strong">Verticalizada</div>
  <div class="screen-subtitle">
    Ingres√° el SKU para obtener IFR y cantidad desde el proveedor.
  </div>

  <div class="field">
    <label>SKU √∫nico <span class="req">*</span></label>
    <input id="vert-sku" placeholder="Escane√° o escrib√≠ el SKU..." />
  </div>

  <div class="btn-row" style="margin-top:12px">
    <button id="btn-vert-cargar-info" type="button" class="btn btn-soft">üîÑ Cargar informaci√≥n de bobina</button>
  </div>

  <hr style="border:none;border-top:1px dashed #e5e7eb;margin:12px 0">

  <form id="form-vert">
    <div class="field-grid">
      <div class="field">
        <label>IFR <span class="badge-auto">Auto</span></label>
        <input id="vert-ifr" readonly />
      </div>
      <div class="field">
        <label>Cantidad <span class="badge-auto">Auto</span></label>
        <input id="vert-cantidad" readonly />
      </div>
      <div class="field">
        <label>Fecha</label>
        <input id="vert-fecha" type="date" readonly />
      </div>
      <div class="field">
        <label>Proveedor <span class="badge-fixed">VERTICALIZADA</span></label>
        <input id="vert-proveedor" value="VERTICALIZADA" readonly />
      </div>
      <div class="field">
        <label>Ubicaci√≥n</label>
        <input id="vert-ubicacion" placeholder="Opcional" />
      </div>
    </div>

    <div class="btn-row-main" style="margin-top:12px">
      <button id="btn-vert-crear" type="button" class="btn btn-primary btn-big">‚úÖ Crear bobina</button>
      <button id="btn-vert-limpiar" type="reset" class="btn btn-secondary">üßπ Limpiar</button>
    </div>

    <div id="status-vert" class="status">
      <span>‚óè</span><span class="msg"></span>
    </div>
  </form>
</section>

</main>

<!------------------------------------------------>
<!-- JAVASCRIPT MEJORADO -->
<!------------------------------------------------>
<script>

// ==========================================================
// CONFIG ‚Äî TUS URLS EXACTAS
// ==========================================================
const FLOW_URL_CREAR_OTROS = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/5b0182b711a54eb3883a94c0f3ee0dd6/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EcpL7k933BlVSFJiI2Ubh5uKR_chYo-rItI9nmmgelQ";

const FLOW_URL_CREAR_VERT  = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/f337efd272244632a9331670dc150286/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=UqusVLipO8E3x5WaRr_9t8XVN0FyTzRGByvHBMr3xlM";

const FLOW_URL_VERTICALIZADA_INFO =
"https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/7db16337d76245078f1e7d079ccd3b86/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=bviGgsVixKAZcoSCEUbTNMzco7kNPFREc_rK9UfhLcQ";

// ==========================================================
// HELPERS
// ==========================================================
function setStatus(box, type, msg) {
  box.className = "status";
  if (!msg) return;

  box.classList.add("visible");
  box.classList.add(type === "ok" ? "ok" : "err");
  box.querySelector(".msg").textContent = msg;
}

async function llamarPOST(url, body) {
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  const text = await r.text();
  let data = null;
  try { data = JSON.parse(text); } catch { data = { raw:text }; }

  console.log("Respuesta flujo:", data);
  return { ok: r.ok, status:r.status, data };
}

// ==========================================================
// NAVEGACI√ìN
// ==========================================================
const screens = {
  home:document.getElementById("screen-home"),
  otros:document.getElementById("screen-otros"),
  vert:document.getElementById("screen-vert")
};

document.querySelectorAll("[data-screen-jump]").forEach(btn=>{
  btn.onclick = ()=>showScreen(btn.dataset.screenJump);
});

const btnHomeTop = document.getElementById("btn-home-top");
btnHomeTop.onclick = ()=>showScreen("home");

function showScreen(name) {
  for (const s in screens)
    screens[s].classList.toggle("active", s===name);

  btnHomeTop.disabled = name==="home";
  btnHomeTop.classList.toggle("active", name!=="home");
}

// ==========================================================
// MAY√öSCULAS
// ==========================================================
["otros-ifr","otros-proveedor","otros-ubicacion","vert-sku","vert-ifr","vert-ubicacion"]
.forEach(id=>{
  const el=document.getElementById(id);
  if (el) el.addEventListener("input", ()=>el.value=el.value.toUpperCase());
});

// ==========================================================
// OTROS PROVEEDORES
// ==========================================================
document.getElementById("btn-otros-crear").onclick = async ()=>{
  const status = document.getElementById("status-otros");
  setStatus(status, "", "");

  const ifr = otros-ifr.value.trim().toUpperCase();
  const cantidad = otros-cantidad.value.trim();
  const proveedor = otros-proveedor.value.trim().toUpperCase();
  const fecha = otros-fecha.value;
  const num = Number(otros-num-bobinas.value.trim());
  const ubic = otros-ubicacion.value.trim().toUpperCase();

  if (!ifr || !cantidad || !proveedor || !fecha || isNaN(num) || num<=0) {
    setStatus(status, "err", "Complet√° todos los campos obligatorios.");
    return;
  }

  const payload = {
    origen:"OTROS_PROVEEDORES",
    ifr, cantidad, proveedor, fecha,
    numeroBobinas:num,
    ubicacion: ubic || null
  };

  const resp = await llamarPOST(FLOW_URL_CREAR_OTROS, payload);

  const body = resp.data?.body ?? resp.data;

  if (resp.ok && body?.ok) {
    setStatus(status, "ok", `Bobina creada. ID: ${body.codigo || "(sin ID)"}`);
  } else {
    setStatus(status, "err", "Error creando bobina. Revis√° Power Automate.");
  }
};

// ==========================================================
// VERTICALIZADA ‚Äî CARGAR INFO DESDE SKU
// ==========================================================
document.getElementById("btn-vert-cargar-info").onclick = async ()=>{
  const status = document.getElementById("status-vert");
  setStatus(status, "", "");

  const sku = vert-sku.value.trim();
  if (!sku) {
    setStatus(status, "err", "Ingres√° el SKU.");
    return;
  }

  const resp = await llamarPOST(FLOW_URL_VERTICALIZADA_INFO, { codigo: sku });

  const payload = resp.data?.body ?? resp.data;

  if (!resp.ok) {
    setStatus(status, "err", "Error llamando al flujo.");
    return;
  }
  if (!payload || (!payload.codigo && !payload.ifr)) {
    setStatus(status, "err", "SKU no encontrado.");
    return;
  }

  vert-ifr.value = (payload.codigo ?? payload.ifr ?? "").toUpperCase();
  vert-cantidad.value = payload.cantidadSugerida ?? payload.cantidad ?? "";
  vert-fecha.value = "";
  vert-proveedor.value = (payload.proveedor ?? "VERTICALIZADA").toUpperCase();

  setStatus(status, "ok", "Datos cargados correctamente.");
};

// ==========================================================
// VERTICALIZADA ‚Äî CREAR
// ==========================================================
document.getElementById("btn-vert-crear").onclick = async ()=>{
  const status = document.getElementById("status-vert");
  setStatus(status, "", "");

  const sku = vert-sku.value.trim();
  if (!sku || !vert-ifr.value.trim() || !vert-cantidad.value.trim()) {
    setStatus(status, "err", "Carg√° primero la informaci√≥n de la bobina.");
    return;
  }

  const payload = {
    origen:"VERTICALIZADA",
    sku: sku.toUpperCase(),
    ifr: vert-ifr.value.trim().toUpperCase(),
    cantidad: vert-cantidad.value.trim(),
    fecha: null,
    proveedor:"VERTICALIZADA",
    ubicacion: vert-ubicacion.value.trim().toUpperCase() || null,
  };

  const resp = await llamarPOST(FLOW_URL_CREAR_VERT, payload);
  const body = resp.data?.body ?? resp.data;

  if (resp.ok && body?.ok) {
    setStatus(status, "ok", `Bobina creada. ID: ${body.codigo || "(sin ID)"}`);
  } else {
    setStatus(status, "err", "No se pudo crear la bobina.");
  }
};

</script>
</body>
</html>
