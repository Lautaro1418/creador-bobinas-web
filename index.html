<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Almac√©n de Etiquetas CQ - Pro Scanner</title>
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>
  <style>
    :root {
      --radius: 12px;
      --ink: #1f2937;
      --muted: #6b7280;
      --bg: #f3f4f6;
      --accent: #1e3a8a;
      --accent-soft: #f0f7ff;
    }

    * { box-sizing: border-box; font-family: 'Inter', system-ui, sans-serif; }
    body { margin: 0; background: #f8fafc; color: var(--ink); padding: 20px 10px; display: flex; justify-content: center; }

    .app { width: 100%; max-width: 850px; background: white; border-radius: 20px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); padding: 24px; }

    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 15px; border-bottom: 1px solid #f1f5f9; }
    header h1 { margin: 0; font-size: 1.25rem; font-weight: 800; color: var(--accent); text-transform: uppercase; }
    
    #btn-home-top { border-radius: 8px; border: 1px solid #e2e8f0; background: white; padding: 8px 12px; font-size: 0.85rem; font-weight: 600; cursor: pointer; display: none; color: var(--muted); }
    #btn-home-top.active { display: flex; align-items: center; gap: 5px; }

    .screen { display: none; animation: fadeIn 0.3s ease; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .grid-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 30px; }
    .card-opt { border-radius: var(--radius); border: 1px solid #e2e8f0; padding: 20px; cursor: pointer; transition: 0.2s; }
    .card-opt:hover { border-color: var(--accent); transform: translateY(-2px); }

    .btn { border-radius: 8px; cursor: pointer; font-size: 0.85rem; padding: 10px 20px; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-weight: 600; border: none; }
    .btn-primary { background: var(--accent); color: white; width: 100%; }
    .btn-soft { background: var(--accent-soft); color: var(--accent); }

    .form-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
    @media (max-width: 600px) { .form-container { grid-template-columns: 1fr; } }

    .field { display: flex; flex-direction: column; gap: 6px; }
    .field label { font-size: 0.75rem; font-weight: 700; color: var(--muted); text-transform: uppercase; }
    .field input { border-radius: 8px; border: 1px solid #d1d5db; padding: 10px 12px; font-size: 0.9rem; }
    input[readonly] { background: #f8fafc; color: #64748b; }

    .status { margin-top: 20px; font-size: 0.85rem; padding: 14px; border-radius: var(--radius); display: none; }
    .status.visible { display: block; }
    .status.ok { background: #f0fdf4; color: #166534; border: 1px solid #bbf7d0; }
    .status.err { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

    /* --- OVERLAY DEL ESC√ÅNER QUAGGA --- */
    #scanner-overlay {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center;
    }
    #interactive.viewport {
      width: 100%; max-width: 500px; height: 300px; background: #000; border-radius: 12px; overflow: hidden; position: relative;
    }
    #interactive.viewport canvas, #interactive.viewport video {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
    }
    /* L√≠nea de escaneo roja */
    .scanner-laser {
      position: absolute; top: 50%; left: 10%; width: 80%; height: 2px;
      background: rgba(255, 0, 0, 0.5); box-shadow: 0 0 8px red; z-index: 10;
    }
  </style>
</head>
<body>

  <div id="scanner-overlay">
    <div style="color:white; margin-bottom:15px; font-weight:bold;">ENFOQUE EL C√ìDIGO DE BARRAS</div>
    <div id="interactive" class="viewport">
      <div class="scanner-laser"></div>
    </div>
    <button onclick="stopScanner()" class="btn btn-primary" style="margin-top:20px; background:#ef4444; width:auto;">‚ùå CANCELAR</button>
  </div>

  <main class="app">
    <header>
      <h1>ALMAC√âN DE ETIQUETAS CQ</h1>
      <button id="btn-home-top" type="button">üè† Inicio</button>
    </header>

    <section id="screen-home" class="screen active">
      <div class="grid-options">
        <div class="card-opt" onclick="showScreen('vert')">
          <h3>‚öôÔ∏è Verticalizada</h3>
          <p>Alta de bobinas por SKU. Lectura r√°pida de Code 128.</p>
          <button class="btn btn-soft">Ingresar</button>
        </div>
        <div class="card-opt" onclick="showScreen('otros')">
          <h3>üì¶ Otros Proveedores</h3>
          <p>Entrada manual y etiquetas para externos.</p>
          <button class="btn btn-soft">Ingresar</button>
        </div>
        <div class="card-opt" onclick="showScreen('reimpresion')" style="grid-column: 1/-1;">
          <h3>üñ®Ô∏è Reimpresi√≥n</h3>
          <p>Generar duplicados de r√≥tulos por ID.</p>
          <button class="btn btn-outline" style="width:100%; border:1px solid #ddd">Acceder</button>
        </div>
      </div>
    </section>

    <section id="screen-otros" class="screen">
      <h2>Otros Proveedores</h2>
      <div class="field">
        <label>IFR / C√ìDIGO</label>
        <div style="display:flex; gap:10px;">
          <input id="otros-ifr" style="flex:1" />
          <button type="button" onclick="startScanner('otros-ifr')" class="btn btn-soft">üì∑</button>
        </div>
      </div>
      </section>

    <section id="screen-vert" class="screen">
      <h2>Verticalizada</h2>
      <div class="field">
        <label>Escanear SKU de Bobina</label>
        <div style="display:flex; gap:10px;">
          <input id="vert-sku" style="flex:1" />
          <button type="button" onclick="startScanner('vert-sku')" class="btn btn-soft">üì∑</button>
          <button type="button" id="btn-vert-cargar-info" class="btn btn-primary" style="width:auto">üîç</button>
        </div>
      </div>
      <div id="status-vert" class="status"></div>
    </section>

    <section id="screen-reimpresion" class="screen">
      <h2>Reimpresi√≥n</h2>
      <div class="field">
        <label>ID de Bobina</label>
        <div style="display:flex; gap:10px;">
          <input id="reimp-id" style="flex:1" />
          <button type="button" onclick="startScanner('reimp-id')" class="btn btn-soft">üì∑</button>
          <button type="button" id="btn-reimp-buscar" class="btn btn-primary" style="width:auto">üîç</button>
        </div>
      </div>
      </section>
  </main>

  <script>
    // --- CONFIGURACI√ìN DE ESC√ÅNER (QUAGGA2) ---
    let currentTargetInput = null;

    function startScanner(targetId) {
      currentTargetInput = targetId;
      document.getElementById('scanner-overlay').style.display = 'flex';

      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#interactive'),
          constraints: {
            facingMode: "environment", // C√°mara trasera
            aspectRatio: { min: 1, max: 2 }
          },
        },
        locator: {
          patchSize: "medium",
          halfSample: true
        },
        decoder: {
          readers: ["code_128_reader"] // Solo Code 128 para velocidad suprema
        },
        locate: true
      }, function(err) {
        if (err) { alert("Error c√°mara: " + err); return; }
        Quagga.start();
      });

      // Al detectar c√≥digo
      Quagga.onDetected((result) => {
        const code = result.codeResult.code;
        if (code) {
          document.getElementById(currentTargetInput).value = code.toUpperCase();
          if (navigator.vibrate) navigator.vibrate(100);
          stopScanner();
          // Auto-busqueda
          if(currentTargetInput === 'vert-sku') document.getElementById('btn-vert-cargar-info').click();
          if(currentTargetInput === 'reimp-id') document.getElementById('btn-reimp-buscar').click();
        }
      });
    }

    function stopScanner() {
      Quagga.stop();
      document.getElementById('scanner-overlay').style.display = 'none';
      currentTargetInput = null;
    }

    // --- L√ìGICA DE NAVEGACI√ìN ---
    const screens = { home: document.getElementById("screen-home"), otros: document.getElementById("screen-otros"), vert: document.getElementById("screen-vert"), reimpresion: document.getElementById("screen-reimpresion") };
    function showScreen(name) {
      Object.entries(screens).forEach(([key, el]) => el.classList.toggle("active", key === name));
      document.getElementById("btn-home-top").classList.toggle("active", name !== "home");
    }
    document.getElementById("btn-home-top").addEventListener("click", () => showScreen("home"));

    // (Pega aqu√≠ tus funciones llamarPOST y EventListeners de los flujos que ya ten√≠as)
  </script>
</body>
</html>
