<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Alta de Bobinas</title>
<style>
:root{
  --radius:14px;--ink:#111827;--muted:#4b5563;--bg:#f3f4f6;
  --ok:#065f46;--err:#991b1b;--accent:#1e3a8a;--accent-strong:#1d4ed8;
}
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system,Segoe UI,sans-serif;
  background:radial-gradient(circle at top,#e5e7eb,#f9fafb);
  display:flex;justify-content:center;align-items:flex-start;
  min-height:100vh;padding:24px 12px;color:var(--ink);
}
.app{
  width:100%;max-width:900px;background:white;border-radius:18px;
  box-shadow:0 18px 45px rgba(15,23,42,0.18);padding:20px;
}
header{
  display:flex;align-items:center;justify-content:center;position:relative;
}
header h1{margin:0;font-size:1.45rem;font-weight:700;text-align:center}
#btn-home-top{
  position:absolute;right:0;top:50%;transform:translateY(-50%);
  border-radius:999px;border:1px solid #e5e7eb;padding:6px 14px;
  background:white;color:#374151;font-size:.8rem;cursor:default;
}
#btn-home-top.active{cursor:pointer;background:linear-gradient(135deg,var(--accent),var(--accent-strong));color:white;border:none}
.screen{display:none;border:1px solid #e5e7eb;border-radius:var(--radius);padding:16px;background:#f9fafb}
.screen.active{display:block}
.screen-title-strong{
  font-size:1.1rem;font-weight:600;color:var(--accent-strong);
  border-left:4px solid var(--accent-strong);padding-left:8px;margin-bottom:8px;
}
.field{display:flex;flex-direction:column;margin-bottom:10px;font-size:.82rem}
.field label{font-weight:600;margin-bottom:2px}
.field input, .field select{
  border-radius:8px;border:1px solid #d1d5db;padding:7px 9px;
  font-size:.82rem
}
.field input:read-only{background:#eee;color:#666}
.btn{
  border:none;border-radius:999px;padding:8px 16px;font-weight:600;
  cursor:pointer
}
.btn-primary{
  background:linear-gradient(135deg,var(--accent),var(--accent-strong));
  color:white
}
.btn-soft{background:#e0ecff;color:var(--accent-strong)}
.status{
  margin-top:10px;padding:8px 10px;border-radius:8px;font-size:.78rem;
  display:none
}
.status.visible{display:flex;align-items:center;gap:6px}
.status.ok{background:#ecfdf3;color:var(--ok);border:1px solid #bbf7d0}
.status.err{background:#fef2f2;color:var(--err);border:1px solid #fecaca}
</style>
</head>

<body>
<main class="app">
<header>
  <h1>Alta de Bobinas</h1>
  <button id="btn-home-top" disabled>üè† Inicio</button>
</header>

<section id="screen-home" class="screen active">
  <p>Eleg√≠ una opci√≥n:</p>
  <button class="btn btn-primary" data-screen-jump="vert">Verticalizada</button>
  <button class="btn btn-primary" data-screen-jump="otros">Otros Proveedores</button>
</section>

<section id="screen-vert" class="screen">
  <div class="screen-title-strong">Verticalizada</div>

  <div class="field">
    <label>SKU √∫nico *</label>
    <input id="vert-sku" />
  </div>

  <button class="btn btn-soft" id="btn-vert-cargar-info">üîÑ Cargar informaci√≥n</button>

  <form id="form-vert">
    <div class="field">
      <label>IFR (auto)</label>
      <input id="vert-ifr" readonly />
    </div>

    <div class="field">
      <label>Cantidad (auto)</label>
      <input id="vert-cantidad" readonly />
    </div>

    <div class="field">
      <label>Fecha (auto)</label>
      <input id="vert-fecha" readonly />
    </div>

    <div class="field">
      <label>Proveedor</label>
      <input id="vert-proveedor" value="VERTICALIZADA" readonly />
    </div>

    <div class="field">
      <label>Ubicaci√≥n</label>
      <input id="vert-ubicacion"/>
    </div>

    <button type="button" class="btn btn-primary" id="btn-vert-crear">‚úÖ Crear bobina</button>
  </form>

  <div id="status-vert" class="status"><span class="msg"></span></div>
</section>

<section id="screen-otros" class="screen">
  <div class="screen-title-strong">Otros Proveedores</div>

  <form id="form-otros">
    <div class="field">
      <label>IFR *</label>
      <input id="otros-ifr" required />
    </div>

    <div class="field">
      <label>Cantidad *</label>
      <input id="otros-cantidad" type="number" required />
    </div>

    <div class="field">
      <label>Proveedor *</label>
      <input id="otros-proveedor" required />
    </div>

    <div class="field">
      <label>Fecha *</label>
      <input id="otros-fecha" type="date" required />
    </div>

    <div class="field">
      <label>N√∫mero de bobinas *</label>
      <input id="otros-num-bobinas" type="number" min="1" required />
    </div>

    <div class="field">
      <label>Ubicaci√≥n</label>
      <input id="otros-ubicacion" />
    </div>

    <button type="button" class="btn btn-primary" id="btn-otros-crear">Crear</button>
  </form>

  <div id="status-otros" class="status"><span class="msg"></span></div>
</section>

</main>

<script>
// ===============================
//  TUS TRES URLS EXACTAS
// ===============================
const FLOW_URL_CREAR_OTROS =
  "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/5b0182b711a54eb3883a94c0f3ee0dd6/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=EcpL7k933BlVSFJiI2Ubh5uKR_chYo-rItI9nmmgelQ";

const FLOW_URL_CREAR_VERT =
  "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/f337efd272244632a9331670dc150286/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=UqusVLipO8E3x5WaRr_9t8XVN0FyTzRGByvHBMr3xlM";

const FLOW_URL_VERTICALIZADA_INFO =
  "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/7db16337d76245078f1e7d079ccd3b86/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=bviGgsVixKAZcoSCEUbTNMzco7kNPFREc_rK9UfhLcQ";

// ===============================
//  NAVEGACI√ìN
// ===============================
function showScreen(name){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById("screen-"+name).classList.add("active");

  const btn = document.getElementById("btn-home-top");
  btn.disabled = name==="home";
  btn.classList.toggle("active", name!=="home");
}

document.querySelectorAll("[data-screen-jump]")
  .forEach(btn=>btn.addEventListener("click",()=>showScreen(btn.dataset.screenJump)));

document.getElementById("btn-home-top").addEventListener("click",()=>{
  if(!event.target.disabled) showScreen("home");
});

// ===============================
//  STATUS helper
// ===============================
function setStatus(el,type,msg){
  el.classList.remove("ok","err","visible");
  if(!msg) return;
  el.classList.add("visible");
  el.classList.add(type==="ok"?"ok":"err");
  el.querySelector(".msg").innerHTML = msg;
}

// ===============================
//  FETCH HELPERS
// ===============================
async function llamarPOST(url,payload){
  const resp = await fetch(url,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });

  const raw = await resp.text();
  let data;
  try{ data = JSON.parse(raw); } catch{ data = { raw } }

  return { ok:resp.ok, status:resp.status, data };
}

// ===============================
//  VERTICALIZADA ‚Üí CARGAR INFO
// ===============================
const inputSku = document.getElementById("vert-sku");
const inputIfr = document.getElementById("vert-ifr");
const inputCant = document.getElementById("vert-cantidad");
const inputFecha = document.getElementById("vert-fecha");
const inputProv = document.getElementById("vert-proveedor");
const inputUbic = document.getElementById("vert-ubicacion");
const statusVert = document.getElementById("status-vert");

document.getElementById("btn-vert-cargar-info").addEventListener("click", async () => {
  setStatus(statusVert,null,"");

  const sku = inputSku.value.trim();
  if(!sku){
    setStatus(statusVert,"err","Ingres√° un SKU.");
    return;
  }

  setStatus(statusVert,"ok","Consultando‚Ä¶");

  const {ok,data} = await llamarPOST(FLOW_URL_VERTICALIZADA_INFO,{
    codigobobina: sku
  });

  const payload = data.body || data;

  if(!ok || !payload || !payload.codigo){
    setStatus(statusVert,"err","El flujo no devolvi√≥ datos v√°lidos.");
    return;
  }

  inputIfr.value = payload.codigo || "";
  inputCant.value = payload.cantidadSugerida || "";
  inputProv.value = (payload.proveedor||"VERTICALIZADA").toUpperCase();
  inputFecha.value = ""; // SIEMPRE VAC√çO

  setStatus(statusVert,"ok","Datos cargados correctamente.");
});

// ===============================
//  VERTICALIZADA ‚Üí CREAR BOBINA
// ===============================
document.getElementById("btn-vert-crear").addEventListener("click", async () => {
  setStatus(statusVert,null,"");

  if(!inputSku.value.trim() || !inputIfr.value.trim()){
    setStatus(statusVert,"err","Carg√° antes la informaci√≥n.");
    return;
  }

  const payload = {
    origen:"VERTICALIZADA",
    sku: inputSku.value.trim(),
    ifr: inputIfr.value.trim(),
    cantidad: inputCant.value.trim(),
    fecha: null,
    proveedor:"VERTICALIZADA",
    ubicacion: inputUbic.value.trim() || null
  };

  const {ok,data}= await llamarPOST(FLOW_URL_CREAR_VERT,payload);

  if(ok && (data.ok===true || data.success===true)){
    setStatus(statusVert,"ok","Bobina creada correctamente.");
  }else{
    setStatus(statusVert,"err","Error creando la bobina.");
  }
});

// ===============================
//  OTROS PROVEEDORES
// ===============================
const statusOtros = document.getElementById("status-otros");

document.getElementById("btn-otros-crear").addEventListener("click", async () => {
  setStatus(statusOtros,null,"");

  const ifr = document.getElementById("otros-ifr").value.trim();
  const cant = document.getElementById("otros-cantidad").value.trim();
  const prov = document.getElementById("otros-proveedor").value.trim();
  const fecha = document.getElementById("otros-fecha").value;
  const num = document.getElementById("otros-num-bobinas").value.trim();
  const ubi = document.getElementById("otros-ubicacion").value.trim();

  if(!ifr || !cant || !prov || !fecha || !num){
    setStatus(statusOtros,"err","Completar todos los campos obligatorios.");
    return;
  }

  const payload = {
    origen:"OTROS_PROVEEDORES",
    ifr,
    cantidad:cant,
    proveedor:prov,
    fecha,
    numeroBobinas:Number(num),
    ubicacion: ubi||null
  };

  const {ok,data}= await llamarPOST(FLOW_URL_CREAR_OTROS,payload);

  if(ok && (data.ok===true || data.success===true)){
    setStatus(statusOtros,"ok","Bobina creada correctamente.");
  }else{
    setStatus(statusOtros,"err","Error creando la bobina.");
  }
});
</script>

</body>
</html>
