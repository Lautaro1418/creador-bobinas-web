<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alta de Bobinas</title>
  <style>
    :root {
      --radius: 14px;
      --ink: #111827;
      --muted: #4b5563;
      --bg: #f3f4f6;
      --ok: #065f46;
      --err: #991b1b;
      --accent: #1e3a8a;
      --accent-strong: #1d4ed8;
      --accent-soft: #dbeafe;
    }

    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, sans-serif; background: radial-gradient(circle at top, #e5e7eb, #f9fafb); color: var(--ink); min-height: 100vh; padding: 24px 12px; display: flex; justify-content: center; }
    .app { width: 100%; max-width: 900px; background: white; border-radius: 18px; box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18); padding: 20px 18px 22px; }
    
    header { position: relative; display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
    header h1 { margin: 0; font-size: 1.45rem; font-weight: 700; }
    
    #btn-home-top { position: absolute; right: 0; border-radius: 999px; border: 1px solid #e5e7eb; background: #ffffff; padding: 6px 14px; font-size: 0.8rem; cursor: pointer; transition: all 0.15s; display: none; }
    #btn-home-top.active { display: inline-flex; background: var(--accent); color: white; border: none; }

    .screen { display: none; border-radius: var(--radius); border: 1px solid #e5e7eb; background: #f9fafb; padding: 16px 14px 18px; }
    .screen.active { display: block; }
    .screen-title-strong { font-size: 1.1rem; color: var(--accent-strong); border-left: 4px solid var(--accent-strong); padding-left: 8px; margin-bottom: 8px; font-weight: 700; }

    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; }
    @media (max-width: 768px) { .grid-3 { grid-template-columns: 1fr; } }

    .card { border-radius: 12px; border: 1px dashed #e5e7eb; background: white; padding: 12px; display: flex; flex-direction: column; }
    .btn { border-radius: 999px; cursor: pointer; font-size: 0.85rem; padding: 8px 16px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; font-weight: 600; transition: all 0.1s; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-secondary { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }
    .btn-soft { background: #e0ecff; color: var(--accent-strong); border: 1px solid #bfdbfe; }
    .btn-outline { background: #ffffff; color: var(--accent-strong); border: 1px solid var(--accent-strong); }

    .field-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    @media (max-width: 600px) { .field-grid { grid-template-columns: 1fr; } }

    .field { display: flex; flex-direction: column; gap: 4px; font-size: 0.8rem; }
    .field label { font-weight: 600; }
    .field label span.req { color: #dc2626; } /* ESTRELLA ROJA */
    .field input { border-radius: 8px; border: 1px solid #d1d5db; padding: 8px; font-size: 0.85rem; outline: none; }
    .field input[readonly] { background: #eeeeee; color: #666; cursor: not-allowed; border-color: #d1d5db; }

    .status { margin-top: 15px; font-size: 0.85rem; padding: 12px; border-radius: 8px; display: none; width: 100%; border-left: 5px solid; }
    .status.visible { display: block; }
    .status.ok { background: #ecfdf3; color: var(--ok); border-color: #059669; }
    .status.err { background: #fef2f2; color: var(--err); border-color: #dc2626; }

    .separator-strong { border: none; border-top: 2px solid #e5e7eb; margin: 24px 0; position: relative; }
    .separator-strong::after { content: "DATOS DE LA BOBINA"; position: absolute; top: -10px; left: 20px; background: #f9fafb; padding: 0 10px; font-size: 0.65rem; font-weight: 800; color: var(--muted); }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <h1>Alta de Bobinas</h1>
      <button id="btn-home-top" type="button">üè† Inicio</button>
    </header>

    <section id="screen-home" class="screen active">
      <div class="screen-title-strong">Panel de Control</div>
      <div class="grid-3">
        <div class="card">
          <h3>‚öôÔ∏è Verticalizada</h3>
          <p style="font-size:0.75rem; color:#666;">Carga autom√°tica v√≠a SKU.</p>
          <button class="btn btn-primary" style="margin-top:auto" data-screen-jump="vert">Ingresar</button>
        </div>
        <div class="card">
          <h3>üì¶ Otros Prov.</h3>
          <p style="font-size:0.75rem; color:#666;">Carga manual externa.</p>
          <button class="btn btn-primary" style="margin-top:auto" data-screen-jump="otros">Ingresar</button>
        </div>
        <div class="card">
          <h3>üñ®Ô∏è Reimpresi√≥n</h3>
          <p style="font-size:0.75rem; color:#666;">Reimprimir etiquetas CQ.</p>
          <button class="btn btn-secondary" style="margin-top:auto" data-screen-jump="reimpresion">Ingresar</button>
        </div>
      </div>
    </section>

    <section id="screen-otros" class="screen">
      <div class="screen-title-strong">Otros Proveedores</div>
      <form id="form-otros">
        <div class="field-grid">
          <div class="field"><label>IFR <span class="req">*</span></label><input id="otros-ifr" required /></div>
          <div class="field"><label>Cantidad <span class="req">*</span></label><input id="otros-cantidad" type="number" step="0.01" required /></div>
          <div class="field"><label>Proveedor <span class="req">*</span></label><input id="otros-proveedor" required /></div>
          <div class="field"><label>Fecha <span class="req">*</span></label><input id="otros-fecha" type="date" required /></div>
          <div class="field"><label>N√∫mero de bobinas <span class="req">*</span></label><input id="otros-num-bobinas" type="number" min="1" required /></div>
          <div class="field"><label>Ubicaci√≥n</label><input id="otros-ubicacion" /></div>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
          <button type="button" id="btn-otros-crear" class="btn btn-primary">‚úÖ Crear bobinas</button>
          <button type="reset" class="btn btn-secondary">Limpiar</button>
        </div>
        <div id="status-otros" class="status"></div>
      </form>
    </section>

    <section id="screen-vert" class="screen">
      <div class="screen-title-strong">Verticalizada</div>
      <div class="field">
        <label>SKU √∫nico <span class="req">*</span></label>
        <input id="vert-sku" placeholder="Escrib√≠ o escane√°..." />
      </div>
      <button type="button" id="btn-vert-cargar-info" class="btn btn-soft" style="margin-top:10px">üîÑ Cargar info</button>
      <div class="separator-strong"></div>
      <form id="form-vert">
        <div class="field-grid">
          <div class="field"><label>IFR</label><input id="vert-ifr" readonly /></div>
          <div class="field"><label>Descripci√≥n</label><input id="vert-descripcion" readonly /></div>
          <div class="field"><label>Cantidad</label><input id="vert-cantidad" readonly /></div>
          <div class="field"><label>Fecha</label><input id="vert-fecha" readonly /></div>
          <div class="field"><label>Proveedor</label><input id="vert-proveedor" value="VERTICALIZADA" readonly /></div>
          <div class="field"><label>Ubicaci√≥n</label><input id="vert-ubicacion" /></div>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
          <button type="button" id="btn-vert-crear" class="btn btn-primary">‚úÖ Crear bobina</button>
          <button type="button" id="btn-vert-imprimir" class="btn btn-outline">üñ®Ô∏è Solo Imprimir</button>
        </div>
        <div id="status-vert" class="status"></div>
      </form>
    </section>

    <section id="screen-reimpresion" class="screen">
      <div class="screen-title-strong">Reimpresi√≥n</div>
      <div class="field">
        <label>ID √önico (CQ...) <span class="req">*</span></label>
        <input id="reimp-id" placeholder="Ej: CQ1234" />
      </div>
      <button type="button" id="btn-reimp-buscar" class="btn btn-soft" style="margin-top:10px">üîç Buscar datos</button>
      <div class="separator-strong"></div>
      <div class="field-grid">
        <div class="field"><label>IFR</label><input id="reimp-ifr" readonly /></div>
        <div class="field"><label>Descripci√≥n</label><input id="reimp-desc" readonly /></div>
        <div class="field"><label>Fecha</label><input id="reimp-fecha" readonly /></div>
      </div>
      <button type="button" id="btn-reimp-imprimir" class="btn btn-primary" style="margin-top:15px; width:100%;">üñ®Ô∏è Imprimir ZPL</button>
      <div id="status-reimp" class="status"></div>
    </section>
  </main>

  <script>
    const FLOW_URL_CREAR_OTROS = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a3aa1e84c2c84404ab6a7f928707e025/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=AYJPbL7RoJjCCgMPnRcoWPHOgQcEh_gGMetpr6z5h3k";
    const FLOW_URL_CREAR_VERT = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/13b36bcf579d431f81f964b55909950e/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=llG5XyDdjYuESJWq9CN-uKKJQ8mHeZUlMY0FbKdNnB0";
    const FLOW_URL_VERTICALIZADA_INFO = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/fe0015c3370a4e4485b1174a1235a4df/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=T4OsXa8va0paJ_DPD4DmbsdDNdVk-2LMh618K1ayt3Y";
    const FLOW_URL_IMPRIMIR_ZPL = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c243919e09ba455ba6e6d9264d0fe59a/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=-FI4sg6jlPGtJou_kFUSMISkhG9BQRkRvzEXbOd9dm0";
    const FLOW_URL_BUSCAR_ID = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/bb66bfd7422f443896757685f12699b8/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=K9YH7cEz1zSDsx0hAVR4Q4LNjd2ppgs5QYZ9GeyBSjo";

    const screens = { home: document.getElementById("screen-home"), otros: document.getElementById("screen-otros"), vert: document.getElementById("screen-vert"), reimpresion: document.getElementById("screen-reimpresion") };
    const btnHomeTop = document.getElementById("btn-home-top");

    function showScreen(name) {
      Object.entries(screens).forEach(([key, el]) => el.classList.toggle("active", key === name));
      btnHomeTop.classList.toggle("active", name !== "home");
      if(name === "otros") setTodayDate("otros-fecha");
    }

    document.querySelectorAll("[data-screen-jump]").forEach(btn => btn.addEventListener("click", () => showScreen(btn.dataset.screenJump)));
    btnHomeTop.addEventListener("click", () => showScreen("home"));

    function setTodayDate(id) {
      const input = document.getElementById(id);
      if (input && !input.value) {
        input.value = new Date().toISOString().split('T')[0];
      }
    }

    function setStatus(el, type, msg) {
      el.classList.remove("ok", "err", "visible");
      if (!msg) return;
      el.classList.add("visible", type);
      el.innerHTML = msg;
    }

    async function llamarPOST(url, payload) {
      const resp = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      const isOk = resp.status >= 200 && resp.status < 300;
      let data = {}; try { data = await resp.json(); } catch(e) {}
      return { ok: isOk, data };
    }

    // OTROS
    document.getElementById("btn-otros-crear").addEventListener("click", async () => {
      const st = document.getElementById("status-otros");
      const payload = {
        codigo: document.getElementById("otros-ifr").value.trim().toUpperCase(),
        cantidadPorBobina: parseInt(document.getElementById("otros-cantidad").value),
        proveedor: document.getElementById("otros-proveedor").value.trim().toUpperCase(),
        fechaIngreso: document.getElementById("otros-fecha").value,
        ubicacion: document.getElementById("otros-ubicacion").value.trim().toUpperCase() || "",
        numeroBobinas: parseInt(document.getElementById("otros-num-bobinas").value)
      };
      setStatus(st, "ok", "Procesando...");
      const { ok, data } = await llamarPOST(FLOW_URL_CREAR_OTROS, payload);
      if(ok) {
        setStatus(st, "ok", `<b>Bobinas Creadas:</b> ${data.ids ? data.ids.join(", ") : "OK"}<br><br><b>Impresiones creadas en carpeta</b>`);
      } else setStatus(st, "err", "Error al crear.");
    });

    // VERTICALIZADA
    document.getElementById("btn-vert-cargar-info").addEventListener("click", async () => {
      const sku = document.getElementById("vert-sku").value.trim();
      const st = document.getElementById("status-vert");
      if(!sku) return;
      setStatus(st, "ok", "Buscando...");
      const { ok, data } = await llamarPOST(FLOW_URL_VERTICALIZADA_INFO, { codigo: sku });
      if(ok && data.ok) {
        document.getElementById("vert-ifr").value = data.codigo;
        document.getElementById("vert-descripcion").value = data.descripcion;
        document.getElementById("vert-cantidad").value = data.cantidadSugerida;
        document.getElementById("vert-fecha").value = data.fecha;
        setStatus(st, "ok", "Datos cargados.");
      } else setStatus(st, "err", "SKU no encontrado.");
    });

    document.getElementById("btn-vert-crear").addEventListener("click", async () => {
      const st = document.getElementById("status-vert");
      const payload = {
        sku: document.getElementById("vert-sku").value.trim().toUpperCase(),
        codigo: document.getElementById("vert-ifr").value,
        cantidadPorBobina: parseInt(document.getElementById("vert-cantidad").value),
        proveedor: "VERTICALIZADA",
        fecha: document.getElementById("vert-fecha").value,
        ubicacion: document.getElementById("vert-ubicacion").value.trim().toUpperCase(),
        descripcion: document.getElementById("vert-descripcion").value,
        numeroBobinas: 1
      };
      setStatus(st, "ok", "Registrando...");
      const { ok } = await llamarPOST(FLOW_URL_CREAR_VERT, payload);
      if(ok) setStatus(st, "ok", "‚úÖ Bobina creada correctamente.");
      else setStatus(st, "err", "Error en el registro.");
    });

    document.getElementById("btn-vert-imprimir").addEventListener("click", async () => {
        const id = document.getElementById("vert-sku").value;
        const cod = document.getElementById("vert-ifr").value;
        const desc = document.getElementById("vert-descripcion").value;
        const fecha = document.getElementById("vert-fecha").value;
        if(!cod) return;
        setStatus(document.getElementById("status-vert"), "ok", "Imprimiendo...");
        await llamarPOST(FLOW_URL_IMPRIMIR_ZPL, { cod: cod, desc: desc, fecha: fecha, id_unico: id });
        setStatus(document.getElementById("status-vert"), "ok", "‚úÖ Orden enviada.");
    });

    // REIMPRESI√ìN
    document.getElementById("btn-reimp-buscar").addEventListener("click", async () => {
      const id = document.getElementById("reimp-id").value.trim().toUpperCase();
      const st = document.getElementById("status-reimp");
      if(!id) return;
      setStatus(st, "ok", "Buscando ID...");
      const { ok, data } = await llamarPOST(FLOW_URL_BUSCAR_ID, { id: id });
      if(ok && data.encontrado) {
        document.getElementById("reimp-ifr").value = data.codigo;
        document.getElementById("reimp-desc").value = data.descripcion;
        document.getElementById("reimp-fecha").value = data.fecha;
        setStatus(st, "ok", "Datos encontrados.");
      } else setStatus(st, "err", "ID no existe en SharePoint.");
    });

    document.getElementById("btn-reimp-imprimir").addEventListener("click", async () => {
      const id = document.getElementById("reimp-id").value.trim();
      const cod = document.getElementById("reimp-ifr").value;
      if(!cod) return;
      setStatus(document.getElementById("status-reimp"), "ok", "Imprimiendo...");
      await llamarPOST(FLOW_URL_IMPRIMIR_ZPL, { 
        cod: cod, 
        desc: document.getElementById("reimp-desc").value, 
        fecha: document.getElementById("reimp-fecha").value, 
        id_unico: id 
      });
      setStatus(document.getElementById("status-reimp"), "ok", "‚úÖ Reimpresi√≥n enviada.");
    });

    // May√∫sculas
    document.querySelectorAll("input").forEach(i => i.addEventListener("input", () => { if(i.type==="text") i.value = i.value.toUpperCase(); }));
  </script>
</body>
</html>

