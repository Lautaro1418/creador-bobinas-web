<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Alta de Bobinas</title>
  <style>
    :root {
      --radius: 14px;
      --ink: #111827;
      --muted: #4b5563;
      --bg: #f3f4f6;
      --ok: #065f46;
      --err: #991b1b;
      --accent: #1e3a8a;
      --accent-strong: #1d4ed8;
      --accent-soft: #dbeafe;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5e7eb, #f9fafb);
      color: var(--ink);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 24px 12px;
    }

    .app {
      width: 100%;
      max-width: 900px;
      background: white;
      border-radius: 18px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.18);
      padding: 20px 18px 22px;
    }

    header {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 12px;
    }

    header h1 {
      margin: 0;
      font-size: 1.45rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-align: center;
    }

    #btn-home-top {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #374151;
      padding: 6px 14px;
      font-size: 0.8rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: default;
      box-shadow: none;
      transition: all 0.15s ease;
    }

    #btn-home-top.active {
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #ffffff;
      border-color: transparent;
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.4);
    }

    .screen {
      display: none;
      border-radius: var(--radius);
      border: 1px solid #e5e7eb;
      background: #f9fafb;
      padding: 16px 14px 18px;
    }

    .screen.active { display: block; }

    .screen-title-strong {
      font-size: 1.1rem;
      color: var(--accent-strong);
      border-left: 4px solid var(--accent-strong);
      padding-left: 8px;
      margin-bottom: 8px;
      font-weight: 700;
    }

    .screen-subtitle {
      font-size: 0.82rem;
      color: var(--muted);
      margin-bottom: 12px;
      line-height: 1.45;
    }

    .grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }

    @media (max-width: 768px) {
      .grid-3 { grid-template-columns: 1fr; }
    }

    .card {
      border-radius: 12px;
      border: 1px dashed #e5e7eb;
      background: white;
      padding: 12px;
      display: flex;
      flex-direction: column;
    }

    .card h3 { margin: 0 0 6px; font-size: 0.9rem; }
    .card p { margin: 0; font-size: 0.75rem; color: var(--muted); flex-grow: 1; }

    .btn {
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      padding: 8px 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-weight: 600;
      transition: all 0.15s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: white;
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    }

    .btn-secondary { background: #f3f4f6; color: #374151; border: 1px solid #e5e7eb; }
    .btn-soft { background: #e0ecff; color: var(--accent-strong); border: 1px solid #bfdbfe; }
    .btn-outline { background: #ffffff; color: var(--accent-strong); border: 1px solid var(--accent-strong); }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    @media (max-width: 600px) { .field-grid { grid-template-columns: 1fr; } }

    .field { display: flex; flex-direction: column; gap: 4px; font-size: 0.8rem; }
    .field label { font-weight: 600; }
    .field input {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 8px;
      font-size: 0.85rem;
    }

    /* MEJORA: El status ahora ocupa su propia l√≠nea sin pisar nada */
    .status {
      margin-top: 15px;
      font-size: 0.82rem;
      padding: 10px;
      border-radius: 8px;
      display: none;
      width: 100%;
      line-height: 1.4;
    }

    .status.visible { display: flex; flex-direction: column; }
    .status.ok { background: #ecfdf3; color: var(--ok); border: 1px solid #bbf7d0; }
    .status.err { background: #fef2f2; color: var(--err); border: 1px solid #fecaca; }

    .separator-strong {
      border: none;
      border-top: 2px solid #e5e7eb;
      margin: 24px 0;
      position: relative;
    }
    .separator-strong::after {
      content: "DATOS DE LA BOBINA";
      position: absolute;
      top: -10px; left: 20px;
      background: #f9fafb; padding: 0 10px;
      font-size: 0.65rem; font-weight: 800; color: var(--muted);
    }

    .badge-auto { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: #ecfdf3; color: #15803d; border: 1px solid #bbf7d0; margin-left: 5px; }
  </style>
</head>
<body>
  <main class="app">
    <header>
      <h1>Alta de Bobinas</h1>
      <button id="btn-home-top" type="button">
        <span class="icon">üè†</span>
        <span class="label">Inicio</span>
      </button>
    </header>

    <section id="screen-home" class="screen active">
      <div class="screen-title-strong">Panel de Control</div>
      <div class="screen-subtitle">Seleccion√° una operaci√≥n para comenzar:</div>

      <div class="grid-3">
        <div class="card">
          <h3>‚öôÔ∏è Verticalizada</h3>
          <p>Flujo automatizado. Escane√° el SKU para cargar datos del proveedor y crear en BDD.</p>
          <button class="btn btn-primary" style="margin-top:10px" data-screen-jump="vert">Ingresar</button>
        </div>
        <div class="card">
          <h3>üì¶ Otros Prov.</h3>
          <p>Carga manual para proveedores externos. Requiere IFR, Cantidad y Proveedor.</p>
          <button class="btn btn-primary" style="margin-top:10px" data-screen-jump="otros">Ingresar</button>
        </div>
        <div class="card">
          <h3>üñ®Ô∏è Reimpresi√≥n</h3>
          <p>¬øSe rompi√≥ la etiqueta? Reimprim√≠ el r√≥tulo ZPL de cualquier bobina usando su ID √∫nico.</p>
          <button class="btn btn-secondary" style="margin-top:10px" data-screen-jump="reimpresion">Ingresar</button>
        </div>
      </div>
    </section>

    <section id="screen-otros" class="screen">
      <div class="screen-title screen-title-strong">Otros Proveedores</div>
      <form id="form-otros">
        <div class="field-grid">
          <div class="field"><label>IFR *</label><input id="otros-ifr" required /></div>
          <div class="field"><label>Cantidad *</label><input id="otros-cantidad" type="number" step="0.01" required /></div>
          <div class="field"><label>Proveedor *</label><input id="otros-proveedor" required /></div>
          <div class="field"><label>Fecha *</label><input id="otros-fecha" type="date" required /></div>
          <div class="field"><label>N√∫mero de bobinas *</label><input id="otros-num-bobinas" type="number" min="1" required /></div>
          <div class="field"><label>Ubicaci√≥n</label><input id="otros-ubicacion" placeholder="Opcional" /></div>
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
          <button type="button" id="btn-otros-crear" class="btn btn-primary btn-big">‚úÖ Crear bobina</button>
          <button type="reset" class="btn btn-secondary">Limpiar</button>
        </div>
        <div id="status-otros" class="status">
          <span class="msg"></span>
        </div>
      </form>
    </section>

    <section id="screen-vert" class="screen">
      <div class="screen-title screen-title-strong">Verticalizada</div>
      <div class="field">
        <label>SKU √∫nico de bobina *</label>
        <input id="vert-sku" placeholder="Escane√° o escrib√≠ el SKU..." />
      </div>
      <button type="button" id="btn-vert-cargar-info" class="btn btn-soft" style="margin-top:10px">üîÑ Cargar informaci√≥n</button>

      <div class="separator-strong"></div>

      <form id="form-vert">
        <div class="field-grid">
          <div class="field"><label>IFR <span class="badge-auto">AUTO</span></label><input id="vert-ifr" readonly /></div>
          <div class="field"><label>Descripci√≥n <span class="badge-auto">AUTO</span></label><input id="vert-descripcion" readonly /></div>
          <div class="field"><label>Cantidad <span class="badge-auto">AUTO</span></label><input id="vert-cantidad" readonly /></div>
          <div class="field"><label>Ubicaci√≥n</label><input id="vert-ubicacion" placeholder="Editable" /></div>
          <input id="vert-fecha" type="hidden" />
          <input id="vert-proveedor" type="hidden" />
        </div>
        <div style="margin-top:15px; display:flex; gap:10px;">
          <button type="button" id="btn-vert-crear" class="btn btn-primary btn-big">‚úÖ Crear bobina</button>
          <button type="button" id="btn-vert-imprimir" class="btn btn-outline" style="border-style:dashed">üñ®Ô∏è Solo Imprimir</button>
        </div>
        <div id="status-vert" class="status"><span class="msg"></span></div>
      </form>
    </section>

    <section id="screen-reimpresion" class="screen">
      <div class="screen-title screen-title-strong">Reimpresi√≥n de R√≥tulos</div>
      <div class="screen-subtitle">
        Utiliz√° esta secci√≥n para imprimir etiquetas de bobinas que ya existen en el sistema.
      </div>
      <div class="card" style="border-style:solid; background:#fff;">
        <div class="field">
          <label>ID √önico de Bobina (CQ...)</label>
          <input id="reimp-id" placeholder="Ej: CQ1234" style="font-size: 1.2rem; text-align: center; border-color: var(--accent);" />
        </div>
        <div style="margin-top:15px; display:flex; flex-direction:column; gap:10px;">
          <button type="button" id="btn-reimp-imprimir" class="btn btn-primary btn-big">üñ®Ô∏è Imprimir Etiqueta ZPL</button>
          <p style="text-align:center; font-size:0.7rem; color:var(--muted); margin-top:5px;">
            Nota: La impresora debe estar encendida y conectada.
          </p>
        </div>
        <div id="status-reimp" class="status"><span class="msg"></span></div>
      </div>
    </section>

  </main>

  <script>
    const FLOW_URL_CREAR_OTROS = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/a3aa1e84c2c84404ab6a7f928707e025/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=AYJPbL7RoJjCCgMPnRcoWPHOgQcEh_gGMetpr6z5h3k";
    const FLOW_URL_CREAR_VERT = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/13b36bcf579d431f81f964b55909950e/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=llG5XyDdjYuESJWq9CN-uKKJQ8mHeZUlMY0FbKdNnB0";
    const FLOW_URL_VERTICALIZADA_INFO = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/fe0015c3370a4e4485b1174a1235a4df/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=T4OsXa8va0paJ_DPD4DmbsdDNdVk-2LMh618K1ayt3Y";
    const FLOW_URL_IMPRIMIR_ZPL = "https://defaultd83e43d1620044fbb4f6a908d91c2e.22.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/c243919e09ba455ba6e6d9264d0fe59a/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=-FI4sg6jlPGtJou_kFUSMISkhG9BQRkRvzEXbOd9dm0";

    const screens = { home: document.getElementById("screen-home"), otros: document.getElementById("screen-otros"), vert: document.getElementById("screen-vert"), reimpresion: document.getElementById("screen-reimpresion") };
    const btnHomeTop = document.getElementById("btn-home-top");

    function showScreen(name) {
      Object.entries(screens).forEach(([key, el]) => el.classList.toggle("active", key === name));
      btnHomeTop.classList.toggle("active", name !== "home");
      btnHomeTop.disabled = name === "home";
    }

    document.querySelectorAll("[data-screen-jump]").forEach(btn => btn.addEventListener("click", () => showScreen(btn.dataset.screenJump)));
    btnHomeTop.addEventListener("click", () => showScreen("home"));

    function setStatus(el, type, msg) {
      if (!el) return;
      el.classList.remove("ok", "err", "visible");
      if (!msg) return;
      el.classList.add("visible", type);
      el.querySelector(".msg").innerHTML = (type === "ok" ? "‚úÖ " : "‚ö†Ô∏è ") + msg;
    }

    async function llamarPOST(url, payload) {
      const resp = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
      const isOk = resp.status >= 200 && resp.status < 300;
      let data;
      try { data = await resp.json(); } catch(e) { data = {}; }
      return { ok: isOk, status: resp.status, data };
    }

    // L√ìGICA REIMPRESI√ìN
    document.getElementById("btn-reimp-imprimir").addEventListener("click", async () => {
      const idUnico = document.getElementById("reimp-id").value.trim().toUpperCase();
      const statusEl = document.getElementById("status-reimp");
      
      if (!idUnico) { setStatus(statusEl, "err", "Ingres√° un ID."); return; }
      
      setStatus(statusEl, "ok", "Enviando orden de impresi√≥n...");
      
      // Enviamos el payload al flujo ZPL. 
      // Nota: Aqu√≠ 'cod' y 'desc' van vac√≠os o gen√©ricos porque el flujo suele buscarlos por ID o el usuario solo quiere el QR.
      const payload = { cod: "-", desc: "REIMPRESI√ìN", fecha: "-", id_unico: idUnico };
      const { ok } = await llamarPOST(FLOW_URL_IMPRIMIR_ZPL, payload);
      
      if (ok) setStatus(statusEl, "ok", "Etiqueta enviada correctamente.");
      else setStatus(statusEl, "err", "Error al conectar con la impresora.");
    });

    // L√ìGICA OTROS PROVEEDORES
    document.getElementById("btn-otros-crear").addEventListener("click", async () => {
      const statusEl = document.getElementById("status-otros");
      const payload = {
        codigo: document.getElementById("otros-ifr").value.trim().toUpperCase(),
        cantidadPorBobina: parseInt(document.getElementById("otros-cantidad").value),
        proveedor: document.getElementById("otros-proveedor").value.trim().toUpperCase(),
        fechaIngreso: document.getElementById("otros-fecha").value,
        ubicacion: document.getElementById("otros-ubicacion").value.trim().toUpperCase() || "ALMACEN",
        numeroBobinas: parseInt(document.getElementById("otros-num-bobinas").value)
      };

      setStatus(statusEl, "ok", "Procesando en BDD...");
      const { ok, data } = await llamarPOST(FLOW_URL_CREAR_OTROS, payload);
      if (ok) setStatus(statusEl, "ok", "Bobinas creadas. IDs: " + (data.ids ? data.ids.join(", ") : "OK"));
      else setStatus(statusEl, "err", "Error en la creaci√≥n.");
    });

    // L√ìGICA VERTICALIZADA
    document.getElementById("btn-vert-cargar-info").addEventListener("click", async () => {
        const sku = document.getElementById("vert-sku").value.trim();
        const statusEl = document.getElementById("status-vert");
        if(!sku) return;
        setStatus(statusEl, "ok", "Buscando...");
        const { ok, data } = await llamarPOST(FLOW_URL_VERTICALIZADA_INFO, { codigo: sku });
        if(ok && data.ok) {
            document.getElementById("vert-ifr").value = data.codigo;
            document.getElementById("vert-descripcion").value = data.descripcion;
            document.getElementById("vert-cantidad").value = data.cantidadSugerida;
            document.getElementById("vert-fecha").value = data.fecha;
            document.getElementById("vert-proveedor").value = data.proveedor || "VERTICALIZADA";
            setStatus(statusEl, "ok", "Datos cargados.");
        } else setStatus(statusEl, "err", "No se encontr√≥ el SKU.");
    });

    document.getElementById("btn-vert-crear").addEventListener("click", async () => {
        const statusEl = document.getElementById("status-vert");
        const payload = {
            sku: document.getElementById("vert-sku").value.trim().toUpperCase(),
            codigo: document.getElementById("vert-ifr").value,
            cantidadPorBobina: parseInt(document.getElementById("vert-cantidad").value),
            proveedor: document.getElementById("vert-proveedor").value,
            fecha: document.getElementById("vert-fecha").value,
            ubicacion: document.getElementById("vert-ubicacion").value.trim().toUpperCase(),
            descripcion: document.getElementById("vert-descripcion").value,
            numeroBobinas: 1
        };
        setStatus(statusEl, "ok", "Creando...");
        const { ok } = await llamarPOST(FLOW_URL_CREAR_VERT, payload);
        if(ok) setStatus(statusEl, "ok", "Bobina Verticalizada creada con √©xito.");
        else setStatus(statusEl, "err", "Error al crear.");
    });

    // May√∫sculas autom√°ticas
    document.querySelectorAll("input").forEach(input => {
        input.addEventListener("input", () => {
            if(input.type === "text") input.value = input.value.toUpperCase();
        });
    });
  </script>
</body>
</html>
